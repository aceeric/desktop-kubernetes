#!/usr/bin/env bash

#
# Creates an ISO from the 'hostonly-netcfg' directory and writes the ISO into the project 'media'
# directory. Result is an ISO with a file that the desktop-kubernetes service (installed by kickstart) can
# use to configure host only networking. The label - CFGENP0S8 - that is assigned to the ISO is important:
# it is checked by the desktop-kubernetes.sh script that is run by the desktop-kubernetes systemd unit.
#
# This script is structurally a clone of gen-kickstart-iso. See that script for additional info.
#
# Usage:
#   gen-hostonly-ifcfg-iso <network octets> <host octet>

# ...where <network octets> are the left three octets of an IPv4 address, and <host octet> is the right-most
# octet of the IP address to configure the adaptor with. E.g.:
#
# gen-hostonly-ifcfg-iso 200.200.200 202
#
# The example above would configure the adaptor with
# IP4 address 200.200.200.202. Note - don't specify '1'
# as the host octet because that's reserved for the gateway in the ifcfg file generated by this script. The
# octets aren't validated by this script - caller must ensure they are valid.
#

set -e

if [[ "$#" -ne 2 ]]; then
  echo "usage: gen-hostonly-ifcfg-iso NETWORK HOST"
  exit 1
fi

proj_root="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# create a config file with the octets patched in
sed -e "s/NETWORK-OCTETS/$1/g" -e "s/HOST-OCTET/$2/g"\
  $proj_root/hostonly-netcfg/template-ifcfg-enp0s8 >| $proj_root/hostonly-netcfg/ifcfg-enp0s8

# create the ISO
rm -f $proj_root/media/ifcfg-enp0s8.iso
genisoimage -J -R -volid CFGENP0S8 -o $proj_root/media/ifcfg-enp0s8.iso $proj_root/hostonly-netcfg
