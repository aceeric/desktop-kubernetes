#!/usr/bin/env bash
#
#
# Creates an ISO that the desktop-kubernetes service (installed by kickstart) can use to configure
# host only networking. The label - CFGENP0S8 - that is assigned to the ISO is important:
# it is checked by the desktop-kubernetes.sh script that is run by the desktop-kubernetes
# systemd unit.
#
# This script is structurally a clone of gen-kickstart-iso. See that script for additional info.
#
# Usage:
#   gen-hostonly-ifcfg-iso <network octets> <host octet>

# ...where <network octets> are the left three octets of an IPv4 address, and <host octet> is the right-most
# octet of the IP address to configure the adaptor with. E.g.:
#
# gen-hostonly-ifcfg-iso 200.200.200 202
#
# The example above would configure the adaptor with IP4 address 200.200.200.202. Note - don't specify '1'
# as the host octet because that's reserved for the gateway in the ifcfg file generated by this script. The
# octets aren't validated by this script - caller must ensure they are valid.
#

set -e

if [[ "$#" -ne 2 ]]; then
  echo "usage: gen-hostonly-ifcfg-iso NETWORK HOST"
  exit 1
fi

# create a config file with the octets patched in
cat <<EOF | sed -e "s/NETWORK-OCTETS/$1/g" -e "s/HOST-OCTET/$2/g" >| $DTKBASE/generated/hostonly-netcfg/ifcfg-enp0s8
TYPE=Ethernet
DEVICE=enp0s8
ONBOOT=yes
BOOTPROTO=none
NAME="enp0s8"
IPADDR=NETWORK-OCTETS.HOST-OCTET
NETMASK=255.255.255.0
NETWORK=NETWORK-OCTETS.0
BROADCAST=NETWORK-OCTETS.255
GATEWAY=NETWORK-OCTETS.1
EOF

# create the ISO
rm -f $DTKBASE/generated/iso/ifcfg-enp0s8.iso
genisoimage -J -R -input-charset utf-8 -volid CFGENP0S8 -o $DTKBASE/generated/iso/ifcfg-enp0s8.iso $DTKBASE/generated/hostonly-netcfg
