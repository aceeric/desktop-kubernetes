#!/usr/bin/env bash
#
# Installs the kube-prometheus stack for cluster observability.
# See - https://github.com/prometheus-operator/kube-prometheus
#

set -e

long_opts=nodes:,kube-prometheus-download:,kube-prometheus-binary:,admin-kubeconfig:
script_name=$(basename "$0")

nodes=
kube_prometheus_download=
kube_prometheus_binary=
admin_kubeconfig=

function opt_val() {
  opt="$1"
  if [[ "$opt" == =* ]]; then
    echo "${opt:1}"
  else
    echo "$opt"
  fi
}

function parse_args() {
  if [[ "$#" -eq 0 ]]; then
    echo "no args provided"
    exit 1
  fi
  local parsed
  parsed=$(getopt --options "" --longoptions $long_opts -n $script_name -- "$@")
  eval set -- "$parsed"
  while true; do
    case "$1" in
	    --nodes)
        nodes=$(opt_val "$2")
        shift 2
        ;;
	    --kube-prometheus-download)
        kube_prometheus_download=$(opt_val "$2")
        shift 2
        ;;
	    --kube-prometheus-binary)
        kube_prometheus_binary=$(opt_val "$2")
        shift 2
        ;;
      --admin-kubeconfig)
        admin_kubeconfig=$(opt_val "$2")
        shift 2
        ;;
      --)
        shift
        break
        ;;
    esac
  done
}

parse_args "$@"

kube_prometheus_binary_actual=$(xec make-download-path\
 --download-url=$kube_prometheus_download --download-path=$kube_prometheus_binary)

xec download-obj --url="$kube_prometheus_download" --dest="$kube_prometheus_binary_actual"

tar zxvf $kube_prometheus_binary_actual --wildcards kube-prometheus-$KUBE_PROMETHEUS_VER'/manifests/setup/*.yaml'\
 --to-command "kubectl --kubeconfig $admin_kubeconfig create -f -"

until kubectl --kubeconfig $admin_kubeconfig get servicemonitors --all-namespaces &>/dev/null; do date; sleep 1;\
  echo "Waiting for kube-prometheus CRDs"; done

tar zxvf $kube_prometheus_binary_actual --exclude setup --wildcards kube-prometheus-$KUBE_PROMETHEUS_VER'/manifests/*.yaml'\
 --to-command "kubectl --kubeconfig $admin_kubeconfig create -f -"

echo "creating NodePort service 'grafana-nodeport' to enble Grafana access without port-forwarding"

# As of kube prometheus v0.12.0 the manifests started including network policies which break the
# NodePort service. As an easy work-around, this script creates an "allow all" network policy per
# the Kubernetes docs here:
# https://kubernetes.io/docs/concepts/services-networking/network-policies/#allow-all-ingress-traffic

cat <<EOF | kubectl --kubeconfig $admin_kubeconfig -n monitoring apply -f -
apiVersion: v1
kind: Service
metadata:
  name: grafana-nodeport
spec:
  ports:
  - name: http
    nodePort: 30300
    port: 3000
    protocol: TCP
    targetPort: 3000
  selector:
    app.kubernetes.io/component: grafana
    app.kubernetes.io/name: grafana
    app.kubernetes.io/part-of: kube-prometheus
  type: NodePort
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-all-ingress
spec:
  podSelector: {}
  ingress:
  - {}
  policyTypes:
  - Ingress
EOF

xec tweak-monitoring $nodes $admin_kubeconfig
