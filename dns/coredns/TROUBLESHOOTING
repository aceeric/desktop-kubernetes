
TUE 26JAN

ALSO HELPFUIL -- https://kubernetes.io/docs/tasks/administer-cluster/dns-debugging-resolution/

added doc/ham to etc/hosts on both
403 already enabled on controller (some other troubleshooting?)
enabled 403 on worker
added to corefile
         pods insecure
         upstream <<<<<<<<<<<<<<<<< broke it so took  out

https://storage.googleapis.com/kubernetes-the-hard-way/coredns-1.7.0.yaml

added to clusterrole
- apiGroups:
  - ""
  resources:
  - nodes
  verbs:
  - get

remove from coredns CMAP
    forward . /etc/resolv.conf {
      max_concurrent 1000
    }

restart coredns pod

EVEN TRIED kubectl apply -f https://storage.googleapis.com/kubernetes-the-hard-way/coredns.yaml

NOPE!

ON worker and controller!

systemctl stop firewalld && systemctl disable firewalld

IMMEDIATELY:

kubectl exec -ti $POD_NAME -- nslookup kubernetes
Server:    10.32.0.10
Address 1: 10.32.0.10 kube-dns.kube-system.svc.cluster.local

Name:      kubernetes
Address 1: 10.32.0.1 kubernetes.default.svc.cluster.local
eace@ubuntu-desktop:~/IdeaProjects/kuvboxctl/newroot$

CONCLUSION:
1) what specific firewall rule is causing this?
   TODO> turn on monitoring to see what is being blocked
2) is there something magic about hightower's coredns yaml??


WEDNESDAY>>>>>>>>>>>>>>>>>>>>>>>>

kubectl exec -ti $POD_NAME -- nslookup kubernetes
SUCCESS
start FW on controller
SUCCESS
start FW on worker
FAIL!!


WORKER

https://serverfault.com/questions/842749/firewalld-logging-denied-packets-enabled-not-logging
firewall-cmd --set-log-denied all && systemctl restart firewalld

Create a file named /etc/rsyslog.d/custom_iptables.conf and add the following statements to it:

cat <<EOF > /etc/rsyslog.d/custom_iptables.conf
:msg,contains,"_DROP" /var/log/iptables.log
:msg,contains,"_REJECT" /var/log/iptables.log
& stop
EOF
sudo systemctl restart rsyslog
Now the dropped and rejected packets will be logged to /var/log/iptables.log

firewall-cmd --permanent --add-port=53/udp
firewall-cmd --reload

INSTANT SUCCESS!!!!!!!!!!

REBUILD FROM SCRACTH
kubectl run busybox --image=busybox:1.28 --command -- sleep 3600
$ kubectl exec -n default -ti busybox -- nslookup kubernetes

FAIL - SO - SOMOETHING ABOVE FIREWALL ALSO???

remove from coredns CMAP
    forward . /etc/resolv.conf {
      max_concurrent 1000
    }

restart coredns pod
NOPE

ON worker repeat denied packets
nothing in /var/log/iptables.log

NOTICED BUT NOT SURE IF IMPORTANT:
worker
cat /var/log/iptables.log
Jan 27 20:12:10 ham kernel: FINAL_REJECT: IN=enp0s3 OUT= MAC=01:00:5e:00:00:fb:fc:65:de:3b:f7:a5:08:00 SRC=192.168.0.30 DST=224.0.0.251 LEN=68 TOS=0x00 PREC=0x00 TTL=1 ID=52866 DF PROTO=UDP SPT=5353 DPT=5353 LEN=48

THAN

added to corefile
         pods insecure

NSLOOKUP SUCCESS

total changes:
1) removed forwarding
2) added pods insecure

AGAIN AUTO REBUILD, then:

kubectl exec -ti busybox -- nslookup kubernetes

SUCCESS!!!!!

*** only two controller variables: 443 and RBAC. need to regen entire cluster to test




https://kubernetes.io/docs/tasks/administer-cluster/dns-debugging-resolution/
kubectl apply -f debugging/dnsutils.yaml
kubectl exec -i -t dnsutils -- nslookup kubernetes.default
kubectl exec -ti dnsutils -- cat /etc/resolv.conf
kubectl exec -i -t dnsutils -- nslookup kubernetes.default
kubectl get pods --namespace=kube-system -l k8s-app=kube-dns
kubectl get svc --namespace=kube-system
kubectl get endpoints kube-dns --namespace=kube-system
