#!/usr/bin/env bash

set -e

long_opts=help,check-compatibility,up:,down:,delete:,verify:,config:,create-template:

# This snippet enables all scripts to exec all other scripts without knowing any
# other script's path, as long all the scripts (except this one) are children
# of the 'scripts' directory.

export DTKBASE="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
function xec() { f=$(find $DTKBASE/scripts -name $1) && $f "${@:2}"; }
export -f xec

# api
config=$DTKBASE/config.yaml
k8s_networking=
k8s_monitoring=
k8s_storage=
k8s_containerized_cplane=
k8s_kubernetes_dashboard=
vbox_host_network_interface=
vbox_host_only_network=
vbox_vboxdir=
vm_linux=
vm_create_template=
vm_create_template_override=
vm_template_vmname=

set -a
source $DTKBASE/artifacts
set +a

#
# option parsing helper
#
function opt_val() {
  opt="$1"
  if [[ "$opt" == =* ]]; then
    echo "${opt:1}"
  else
    echo "$opt"
  fi
}

#
# parses command line parameters and sets script variables from them, executes helper
# commands, like --up for example.
#
function parse_args() {
  local parsed
  local script_name=$(basename "$0")
  parsed=$(getopt --options "" --longoptions $long_opts -n $script_name -- "$@")
  eval set -- "$parsed"
  while true; do
    case "$1" in
      --help)
        xec show-usage
        exit 0
        ;;
      --config)
        config=$(opt_val "$2")
        config=$(realpath $config)
        if [[ ! -f "$config" ]]; then
          echo "config file not found: $config"
          exit 1
        fi
        shift 2
        ;;
      --check-compatibility)
        echo "checking version compatibility"
        xec check-compatibility
        exit 0
        ;;
      --up)
        vms=$(opt_val "$2")
        xec up-down-del "up" $vms
        exit 0
        ;;
      --down)
        vms=$(opt_val "$2")
        xec up-down-del "down" $vms
        exit 0
        ;;
      --delete)
        vms=$(opt_val "$2")
        xec up-down-del "delete" $vms
        exit 0
        ;;
      --verify)
        verify=$(opt_val "$2")
        if [[ "$verify" != "upstreams" ]] && [[ "$verify" != "files" ]]; then
          echo "unsupported parameter value for --verify option: $verify"
          exit 1
        fi
        xec check-objects "$verify"
        exit 0
        ;;
      --create-template)
        vm_create_template_override=$(opt_val "$2")
        if [[ "$vm_create_template_override" != "true" ]] && [[ "$vm_create_template_override" != "false" ]]; then
          echo "--create-template arg needs true or false"
          exit 1
        fi
        shift 2
        ;;
      --)
        shift
        break
        ;;
    esac
  done

  if [[ $# -ne 0 ]]; then
    echo "unsupported command line option(s): $@"
    exit 1
  fi
}

# entry point

# parse cmdline
parse_args "$@"

# parse config.yaml
eval $(xec parse-config $config)

if [[ -n "$vm_create_template_override" ]]; then
  if [[ "$vm_create_template_override" == "true" ]]; then
    vm_create_template=1
  else
    vm_create_template=0
  fi
fi

if [[ -z "$vbox_vboxdir" ]]; then
  vbox_vboxdir=$(vboxmanage list systemproperties | grep folder | awk -F: '{print $2}' | xargs)
fi

# validate configuration
if [[ -z "$vbox_host_network_interface" ]] && [[ -z "$vbox_host_only_network" ]]; then
  echo "either --host-network-interface or --host-only-network is required"
  exit 1
elif [[ ! -z "$vbox_host_network_interface" ]] && [[ ! -z "$vbox_host_only_network" ]]; then
  echo "--host-network-interface and --host-only-network are exclusive of each other"
  exit 1
elif [[ -z "$vbox_vboxdir" ]]; then
  echo "directory for virtualbox VMs is not defined"
  exit 1
elif [[ ! -d $vbox_vboxdir ]]; then
  echo "directory for virtualbox VMs does not exist: $vbox_vboxdir"
  exit 1
elif [[ ! -z "$k8s_networking" ]] && [[ "$k8s_networking" != "cilium" ]] && [[ "$k8s_networking" != "calico" ]]; then
  echo "unsupported parameter value for k8s.networking config: $k8s_networking"
  exit 1
elif [[ ! -z "$k8s_monitoring" ]] && [[ "$k8s_monitoring" != "metrics.k8s.io" ]] && [[ "$k8s_monitoring" != "kube-prometheus" ]]; then
  echo "unsupported parameter value for k8s.monitoring config: $k8s_monitoring"
  exit 1
elif [[ ! -z "$k8s_storage" ]] && [[ "$k8s_storage" != "openebs" ]]; then
  echo "unsupported parameter value for storage config: $k8s_storage"
  exit 1
# removing centos9 for now - can't get it working [[ "$vm_linux" != "centos9" ]] && 
elif [[ "$vm_linux" != "centos8" ]] && [[ "$vm_linux" != "rocky" ]]  && [[ "$vm_linux" != "alma" ]]; then
  echo "unsupported parameter value for linux config: $vm_linux"
  exit 1
fi

echo "creating directories to generate various files into"
mkdir -p $DTKBASE/generated/kickstart\
         $DTKBASE/generated/kubeconfig\
         $DTKBASE/generated/cert\
         $DTKBASE/generated/hostonly-netcfg\
         $DTKBASE/generated/iso

echo "downloading all objects needed to provision the cluster"
xec download-objects\
  --create-template=$vm_create_template\
  --linux=$vm_linux\
  --monitoring=$k8s_monitoring\
  --storage=$k8s_storage\
  --networking=$k8s_networking\
  --kubernetes-dashboard=$k8s_kubernetes_dashboard

echo "provisioning vms"
xec provision-vms\
  --create-template=$vm_create_template\
  --linux=$vm_linux\
  --host-network-interface=$vbox_host_network_interface\
  --host-only-network=$vbox_host_only_network\
  --vboxdir=$vbox_vboxdir\
  --template-vmname=$vm_template_vmname\
  --config=$config

echo "generating root CA to $DTKBASE/generated/cert/ca.pem (and ca-key.pem)"
xec gen-root-ca

echo "generating Kubernetes core cluster"
xec gen-core-k8s\
  --containerized-cplane=$k8s_containerized_cplane\
  --priv-key=$DTKBASE/generated/kickstart/id_ed25519\
  --ca-cert=$DTKBASE/generated/cert/ca.pem\
  --ca-key=$DTKBASE/generated/cert/ca-key.pem\
  --config=$config

# build a comma-separated list of VMs
for ((i = 0; i < $(xec yp $config ?vms); ++i)); do
  nodes="$nodes,$(xec yp $config vms/$i/name)"
done
nodes=${nodes:1}

# host zero is always the controller
controller_ip=$(xec get-vm-ip $(xec yp $config vms/0/name))

xec install-addons\
  --admin-kubeconfig=$DTKBASE/generated/kubeconfig/admin.kubeconfig\
  --ca-cert=$DTKBASE/generated/cert/ca.pem\
  --ca-key=$DTKBASE/generated/cert/ca-key.pem\
  --cluster-cidr=10.200.0.0/16\
  --containerized-cplane=$containerized_cplane\
  --controller-ip=$controller_ip\
  --nodes=$nodes\
  --priv-key=$DTKBASE/generated/kickstart/id_ed25519\
  --networking=$k8s_networking\
  --monitoring=$k8s_monitoring\
  --storage=$k8s_storage\
  --kubernetes-dashboard=$k8s_kubernetes_dashboard

echo
echo "finished provisioning cluster. To interact with the cluster:"
echo "  export KUBECONFIG=$DTKBASE/generated/kubeconfig/admin.kubeconfig"
echo

xec show-ssh $DTKBASE/generated/kickstart/id_ed25519 $nodes
