

https://storage.googleapis.com/kubernetes-the-hard-way/coredns-1.7.0.yaml
https://github.com/coredns/deployment/tree/master/kubernetes


curl -sL https://github.com/coredns/deployment/raw/coredns-1.14.0/kubernetes/deploy.sh -o deploy.sh
curl -sL https://github.com/coredns/deployment/raw/coredns-1.14.0/kubernetes/coredns.yaml.sed -o coredns.yaml.sed

# should produce no results
kubectl -n kube-system get --ignore-not-found ServiceAccount     coredns && \
kubectl -n kube-system get --ignore-not-found ClusterRole        system:coredns && \
kubectl -n kube-system get --ignore-not-found ClusterRoleBinding system:coredns && \
kubectl -n kube-system get --ignore-not-found ConfigMap          coredns && \
kubectl -n kube-system get --ignore-not-found Deployment         coredns && \
kubectl -n kube-system get --ignore-not-found Service            kube-dns

source ./deploy.sh -i 10.32.0.10 -s > ./coredns.yaml &&
sed -i 's|image: coredns|image: docker.io/coredns|' coredns.yaml



kubectl apply -f coredns.yaml
serviceaccount/coredns created
clusterrole.rbac.authorization.k8s.io/system:coredns created
clusterrolebinding.rbac.authorization.k8s.io/system:coredns created
configmap/coredns created
deployment.apps/coredns created
service/kube-dns created

kubectl get pods -l k8s-app=kube-dns -n kube-system

TREOUBLESHOOTING

## TODO PUT BACK OR AUTOMATE IF NEEDED!
in cluster deleted 'forward' section and coredns pod / no luck

https://kubernetes.io/docs/tasks/administer-cluster/dns-debugging-resolution/#known-issues
https://stackoverflow.com/questions/59890834/k8s-coredns-and-flannel-nameserver-limit-exceeded

WED 3:11 did this:
cat <<EOF >>/etc/hosts
192.168.0.46 centos81
192.168.0.47 worker
EOF

had an immediate effect (NOTE I HAD REMOVED THE forward section FROM CONFIRGMAP)
$ kubectl -n kube-system logs coredns-75c4c67f76-d2fqp
Error from server: Get "https://worker:10250/containerLogs/kube-system/coredns-75c4c67f76-d2fqp/coredns": dial tcp 192.168.0.47:10250: connect: no route to host

RERAN FIREWALL RULES ON WORKER AND RESTARTED FIREWALLD

THEN

$ kubectl -n kube-system logs coredns-75c4c67f76-d2fqp
Error from server (Forbidden): Forbidden (user=kubernetes, verb=get, resource=nodes, subresource=proxy) ( pods/log coredns-75c4c67f76-d2fqp)

RBACS IN HIGHTOWER ?

so
 - hand edited clusterrole system:coredns
 - delete po
 - no change
   $ kubectl -n kube-system logs coredns-75c4c67f76-jpvsp
   Error from server (Forbidden): Forbidden (user=kubernetes, verb=get, resource=nodes, subresource=proxy) ( pods/log coredns-75c4c67f76-jpvsp)




https://stackoverflow.com/questions/59918967/kubernetes-pods-logs-shows-forbidden
 You need to create a clusterrole
   kubectl create clusterrole deleteme --verb=get,proxy --resource=nodes
 and a clusterrolebinding
   kubectl create clusterrolebinding deleteme --clusterrole=deleteme --user=kubernetes

NOPE!

HERE AT EOD:
https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/troubleshooting-kubeadm/

DISABLE SELINUX!!!!!!! WHICH I DIDNT DO!!!!!!

WED 8:35 PM
worker:
sed -i 's/SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config

# before reboot
# getenforce
Enforcing

# after reboot
# getenforce
Disabled

kubectl -n kube-system delete po coredns-75c4c67f76-jpvsp

WED 9:52 PM
- added 10.32.0.1 to /home/eace/k8sbyhand/tls/csr.conf
- regen kubernetes.pem and copy to controller /root/kubernetes and /var/lib/kubernetes
- restart api server

$ kubectl -n kube-system get pod
NAME                       READY   STATUS    RESTARTS   AGE
alpine                     1/1     Running   0          51m
coredns-75c4c67f76-kvhqd   1/1     Running   0          30m

SUCCESS !!!!

BUT!!

$ kubectl -n kube-system exec -it alpine -- nslookup kubernetes
;; connection timed out; no servers could be reached

command terminated with exit code 1

so scaled coredns deploy down and up now (as of 10:15 PM)

$ kubectl -n kube-system logs coredns-75c4c67f76-8nmpt
.:53
[INFO] plugin/reload: Running configuration MD5 = 0b1f7c7c4e8a07a040a9d37e8fc4e587
CoreDNS-1.8.0
linux/amd64, go1.15.3, 054c9ae
[ERROR] plugin/errors: 2 1696376841105142338.7774884790572480942. HINFO: plugin/loop: no next plugin found

10:30 PM removed 'loop' from coredns CM

NO EFFECT

10:48 PM STUCK!! <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<


THURSDAY

kubectl -n kube-system describe cm coredns
.:53 {
    errors
    health {
      lameduck 5s
    }
    ready
    kubernetes cluster.local in-addr.arpa ip6.arpa {
      fallthrough in-addr.arpa ip6.arpa
    }
    prometheus :9153
    cache 30
    reload
    loadbalance
}

# notice no plugin error:
kubectl -n kube-system logs coredns-75c4c67f76-8rtdn
.:53
[INFO] plugin/reload: Running configuration MD5 = 653a140ec8c210fbf8de424de7e2ddfc
CoreDNS-1.8.0
linux/amd64, go1.15.3, 054c9ae

kubectl -n kube-system exec -ti alpine -- nslookup kubernetes

;; connection timed out; no servers could be reached

some ideas:
iptables -P FORWARD ACCEPT


firewall-cmd --set-log-denied=all
firewall-cmd --reload

dmesg | grep -i REJECT


# 2:12
hand edit /var/lib/kubelet/kubelet-config.yaml in VM
resolvConf: "/etc/resolv.conf"
made no difference

# 2:27 THU
POSSIBILITY - I need to configure routes on the worker that xlat pod CIDR addresses into host addresses?

SAT 1/2
================
added back to CM and scaled coredns deploy
        forward . /etc/resolv.conf {
          max_concurrent 1000
        }

NO DIFFERENCE
ping 10.32.0.10

100% packet loss

ON WORKER:

firewall-cmd --permanent --zone=public --add-port=53/udp
firewall-cmd --permanent --zone=public --add-port=53/tcp
firewall-cmd --permanent --zone=public --add-port=9153/tcp
firewall-cmd --reload

$ kubectl -n kube-system exec -ti alpine -- nslookup kubernetes
;; connection timed out; no servers could be reached

NO CHANGE!

12:24 AM SUNDAY!!!
/home/eace/k8sbyhand/kube-router/notes

... then

NO CHANGE!!!!!


MONDAY 04-JAN

IS THIS NEEDED FOR KUBE-ROUTER?
https://computingforgeeks.com/setup-linux-virtual-server-load-balancer-on-centos-rhel/

check this out
https://www.cni.dev/plugins/main/bridge/




TODO:
1) do I need the rbacs in the coredns clusterrole that hightower added?
2) can I safely add back in the 'forward' section of the coredns configmap?
























